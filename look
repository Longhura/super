--[[
    Script: LookAtGUI Ho√†n Ch·ªânh
    M√¥ t·∫£: Hi·ªÉn th·ªã GUI cho ph√©p nh√¨n v√†o ng∆∞·ªùi ch∆°i kh√°c,
           t·ª± ƒë·ªông x·ª≠ l√Ω khi b·∫£n th√¢n ho·∫∑c m·ª•c ti√™u ch·∫øt,
           v√† c√≥ ch·ª©c nƒÉng d·ªãch chuy·ªÉn ra sau l∆∞ng m·ª•c ti√™u.
]]

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService") -- Th√™m cho ki·ªÉm tra thi·∫øt b·ªã

-- Local Player Variables
local Player = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Character = Player.Character or Player.CharacterAdded:Wait() -- L·∫•y nh√¢n v·∫≠t hi·ªán t·∫°i ho·∫∑c ch·ªù nh√¢n v·∫≠t m·ªõi
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- GUI setup
local ScreenGui = Instance.new("ScreenGui", Player:WaitForChild("PlayerGui"))
ScreenGui.Name = "LookAtGUI"
ScreenGui.ResetOnSpawn = false -- Gi·ªØ GUI khi ch·∫øt
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling -- ƒê·∫£m b·∫£o GUI kh√¥ng b·ªã che b·ªüi UI kh√°c

-- === V·ªã tr√≠ v√† K√≠ch th∆∞·ªõc Frame ===
local frameWidth = 260
local frameHeight = 300
local framePosX = 0.02
local framePosY = 0.2

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, frameWidth, 0, frameHeight)
Frame.Position = UDim2.new(framePosX, 0, framePosY, 0)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.Active = true
Frame.Draggable = true
Frame.BorderSizePixel = 0
Frame.ClipsDescendants = true -- ƒê·∫£m b·∫£o n·ªôi dung kh√¥ng tr√†n vi·ªÅn

Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 8)

local UIStroke = Instance.new("UIStroke", Frame)
UIStroke.Thickness = 2
UIStroke.Color = Color3.fromRGB(255, 0, 0) -- M√†u vi·ªÅn ban ƒë·∫ßu

-- === H√†ng Ti√™u ƒë·ªÅ v√† N√∫t ƒêi·ªÅu khi·ªÉn ===
local titleBarHeight = 30
local buttonSize = 24
local buttonPadding = 5

local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1, -(buttonSize * 2 + buttonPadding * 3), 0, titleBarHeight)
Title.Position = UDim2.new(0, buttonPadding, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "Nh√¨n Ng∆∞·ªùi Ch∆°i"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 15
Title.TextColor3 = Color3.new(1,1,1)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextYAlignment = Enum.TextYAlignment.Center

local CloseButton = Instance.new("TextButton", Frame)
CloseButton.Size = UDim2.new(0, buttonSize, 0, buttonSize)
CloseButton.Position = UDim2.new(1, -(buttonSize + buttonPadding), 0, (titleBarHeight - buttonSize) / 2)
CloseButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
CloseButton.Text = "‚úï"
CloseButton.TextColor3 = Color3.new(1,1,1)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 14
Instance.new("UICorner", CloseButton).CornerRadius = UDim.new(0, 4)

local MinimizeButton = Instance.new("TextButton", Frame)
MinimizeButton.Size = UDim2.new(0, buttonSize, 0, buttonSize)
MinimizeButton.Position = UDim2.new(1, -(buttonSize * 2 + buttonPadding * 2), 0, (titleBarHeight - buttonSize) / 2)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
MinimizeButton.Text = "-"
MinimizeButton.TextColor3 = Color3.new(1,1,1)
MinimizeButton.Font = Enum.Font.GothamBold
MinimizeButton.TextSize = 18
Instance.new("UICorner", MinimizeButton).CornerRadius = UDim.new(0, 4)

-- === C√°c n√∫t ch·ª©c nƒÉng ===
local buttonHeight = 28
local buttonSpacing = 5
local currentY = titleBarHeight + buttonSpacing * 2 -- B·∫Øt ƒë·∫ßu d∆∞·ªõi thanh ti√™u ƒë·ªÅ

local function CreateFunctionButton(text, color, yPos)
	local btn = Instance.new("TextButton", Frame)
	btn.Size = UDim2.new(1, -buttonPadding * 2, 0, buttonHeight)
	btn.Position = UDim2.new(0, buttonPadding, 0, yPos)
	btn.BackgroundColor3 = color
	btn.Text = text
	btn.TextColor3 = Color3.new(1,1,1)
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 14
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)
	return btn
end

local toggleButton = CreateFunctionButton("‚úÖ B·∫≠t Nh√¨n", Color3.fromRGB(0, 170, 0), currentY)
currentY += buttonHeight + buttonSpacing

local partButton = CreateFunctionButton("Nh√¨n: Head", Color3.fromRGB(80, 80, 80), currentY)
currentY += buttonHeight + buttonSpacing

local reloadButton = CreateFunctionButton("T·∫£i l·∫°i danh s√°ch", Color3.fromRGB(80, 80, 80), currentY)
currentY += buttonHeight + buttonSpacing

local nearestButton = CreateFunctionButton("üìç Ch·ªçn G·∫ßn Nh·∫•t", Color3.fromRGB(255, 165, 0), currentY)
currentY += buttonHeight + buttonSpacing

local teleportButton = CreateFunctionButton("üö∂ D·ªãch Chuy·ªÉn Sau L∆∞ng", Color3.fromRGB(60, 60, 200), currentY)
currentY += buttonHeight + buttonSpacing * 2

-- === Danh s√°ch ng∆∞·ªùi ch∆°i ===
local listHeight = frameHeight - currentY - buttonPadding -- T√≠nh to√°n chi·ªÅu cao c√≤n l·∫°i cho danh s√°ch
local playerList = Instance.new("ScrollingFrame", Frame)
playerList.Position = UDim2.new(0, buttonPadding, 0, currentY)
playerList.Size = UDim2.new(1, -buttonPadding * 2, 0, listHeight)
playerList.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
playerList.ScrollBarThickness = 6
playerList.CanvasSize = UDim2.new(0, 0, 0, 0)
playerList.BorderSizePixel = 0
Instance.new("UICorner", playerList).CornerRadius = UDim.new(0, 5)

-- === Icon Thu nh·ªè ===
local MinimizedIcon = Instance.new("TextButton", ScreenGui)
MinimizedIcon.Size = UDim2.new(0, 80, 0, 25) -- K√≠ch th∆∞·ªõc nh·ªè h∆°n
MinimizedIcon.Position = UDim2.new(0, 5, 1, -30) -- G√≥c d∆∞·ªõi c√πng b√™n tr√°i
MinimizedIcon.Text = "M·ªü Nh√¨n"
MinimizedIcon.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
MinimizedIcon.TextColor3 = Color3.new(1,1,1)
MinimizedIcon.Font = Enum.Font.Gotham
MinimizedIcon.TextSize = 12
MinimizedIcon.Visible = false
MinimizedIcon.Active = true
MinimizedIcon.Draggable = true
Instance.new("UICorner", MinimizedIcon).CornerRadius = UDim.new(0, 4)

-- Variables
local looking = true -- Tr·∫°ng th√°i nh√¨n (b·∫≠t/t·∫Øt)
local bodyParts = {"Head", "UpperTorso", "HumanoidRootPart", "LeftFoot", "RightFoot"}
local partIndex = 1 -- Index b·ªô ph·∫≠n c∆° th·ªÉ ƒëang nh√¨n
local currentTarget = nil -- Player object ƒëang ƒë∆∞·ª£c ch·ªçn l√†m m·ª•c ti√™u
local buttons = {} -- Table ch·ª©a c√°c n√∫t ng∆∞·ªùi ch∆°i trong playerList
local targetHumanoidConnection = nil -- Connection cho s·ª± ki·ªán Died c·ªßa m·ª•c ti√™u
local selfHumanoidDiedConnection = nil -- Connection cho s·ª± ki·ªán Died c·ªßa b·∫£n th√¢n
local lookAtRenderStepConnection = nil -- Connection cho RenderStep nh√¨n
local listButtonYOffset = 3 -- Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t trong danh s√°ch

-- Rainbow border
local colors = {
	Color3.fromRGB(255, 0, 0), Color3.fromRGB(255, 127, 0), Color3.fromRGB(255, 255, 0),
	Color3.fromRGB(0, 255, 0), Color3.fromRGB(0, 255, 255), Color3.fromRGB(0, 0, 255),
	Color3.fromRGB(139, 0, 255)
}
task.spawn(function()
	local i = 1
	while ScreenGui.Parent do
		if UIStroke and UIStroke.Parent then -- Ki·ªÉm tra UIStroke c√≤n t·ªìn t·∫°i kh√¥ng
			local color = colors[i]
			local tween = TweenService:Create(UIStroke, TweenInfo.new(0.4), {Color = color})
			tween:Play()
			tween.Completed:Wait()
			i = i % #colors + 1
		else
			break -- Tho√°t n·∫øu UIStroke b·ªã h·ªßy
		end
		task.wait(0.05) -- Th√™m kho·∫£ng ch·ªù nh·ªè ƒë·ªÉ tr√°nh t·ªën t√†i nguy√™n
	end
end)

-- Function ƒë·ªÉ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa nh√¢n v·∫≠t b·∫£n th√¢n
local function isSelfCharacterValid()
    return Character and Character.Parent and Humanoid and Humanoid.Health > 0 and HumanoidRootPart and HumanoidRootPart.Parent
end

-- Function ƒë·ªÉ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa nh√¢n v·∫≠t m·ª•c ti√™u
local function isTargetCharacterValid(targetPlayer)
    if not targetPlayer or not targetPlayer:IsA("Player") then return false end
    local targetChar = targetPlayer.Character
    if not targetChar or not targetChar.Parent then return false end
    local targetHum = targetChar:FindFirstChildOfClass("Humanoid")
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    return targetHum and targetHum.Health > 0 and targetHRP and targetHRP.Parent
end


-- Function ƒë·ªÉ highlight n√∫t ng∆∞·ªùi ch∆°i ƒë∆∞·ª£c ch·ªçn
local function highlightSelectedButton(selectedPlayer)
    for player, btnInfo in pairs(buttons) do
        if btnInfo and btnInfo.button and btnInfo.button.Parent then -- Ki·ªÉm tra n√∫t c√≤n t·ªìn t·∫°i kh√¥ng
            local btn = btnInfo.button
            local stroke = btn:FindFirstChildOfClass("UIStroke")
            if player == selectedPlayer then
                btn.BackgroundColor3 = Color3.fromRGB(120, 120, 120) -- M√†u s√°ng h∆°n cho n√∫t ƒë∆∞·ª£c ch·ªçn
                if stroke then stroke.Enabled = true end -- B·∫≠t vi·ªÅn
            else
                btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70) -- M√†u m·∫∑c ƒë·ªãnh
                 if stroke then stroke.Enabled = false end -- T·∫Øt vi·ªÅn
            end
        end
    end
end

-- Function ƒë·ªÉ x·ª≠ l√Ω khi m·ª•c ti√™u ch·∫øt
local function handleTargetDied(player)
    print(player.Name, "ƒë√£ ch·∫øt.") -- Debug
    -- Ch·ªâ x·ª≠ l√Ω n·∫øu m·ª•c ti√™u b·ªã ch·∫øt *ch√≠nh l√†* m·ª•c ti√™u ƒëang ƒë∆∞·ª£c ch·ªçn
    if currentTarget == player then
        looking = false -- T·∫ÆT NH√åN
        toggleButton.Text = "‚ùé T·∫Øt Nh√¨n" -- C·∫≠p nh·∫≠t n√∫t nh√¨n
        toggleButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
        currentTarget = nil -- B·ªé CH·ªåN m·ª•c ti√™u
        highlightSelectedButton(nil) -- B·ªè highlight n√∫t ng∆∞·ªùi ch∆°i

        -- Ng·∫Øt k·∫øt n·ªëi Died sau khi ƒë√£ x·ª≠ l√Ω
        if targetHumanoidConnection then
            targetHumanoidConnection:Disconnect()
            targetHumanoidConnection = nil
            print("ƒê√£ ng·∫Øt k·∫øt n·ªëi Died c·ªßa m·ª•c ti√™u.") -- Debug
        end
    end
end

-- Function ƒë·ªÉ ƒë·∫∑t m·ª•c ti√™u m·ªõi
local function setTarget(player)
	if currentTarget == player then return end -- Kh√¥ng l√†m g√¨ n·∫øu ch·ªçn l·∫°i c√πng m·ª•c ti√™u

    print("ƒêang ch·ªçn m·ª•c ti√™u:", player.Name) -- Debug

	-- Ng·∫Øt k·∫øt n·ªëi Died c≈© c·ªßa m·ª•c ti√™u tr∆∞·ªõc ƒë√≥ n·∫øu c√≥
	if targetHumanoidConnection then
		targetHumanoidConnection:Disconnect()
		targetHumanoidConnection = nil
        print("ƒê√£ ng·∫Øt k·∫øt n·ªëi Died c·ªßa m·ª•c ti√™u c≈©.") -- Debug
	end

	currentTarget = player -- ƒê·∫∑t m·ª•c ti√™u m·ªõi

	-- K·∫øt n·ªëi theo d√µi m√°u c·ªßa m·ª•c ti√™u m·ªõi
	local char = player.Character
	if char then
		local humanoid = char:FindFirstChildOfClass("Humanoid")
		if humanoid then
            -- K·∫øt n·ªëi s·ª± ki·ªán Died
			targetHumanoidConnection = humanoid.Died:Connect(function()
                handleTargetDied(player) -- G·ªçi h√†m x·ª≠ l√Ω ri√™ng
            end)
            print("ƒê√£ k·∫øt n·ªëi Died cho m·ª•c ti√™u:", player.Name) -- Debug
        else
            print("Kh√¥ng t√¨m th·∫•y Humanoid cho m·ª•c ti√™u:", player.Name) -- Debug
            -- N·∫øu kh√¥ng t√¨m th·∫•y humanoid, coi nh∆∞ kh√¥ng th·ªÉ theo d√µi -> b·ªè ch·ªçn
            currentTarget = nil
		end
	else
	    print("Kh√¥ng t√¨m th·∫•y Character cho m·ª•c ti√™u:", player.Name) -- Debug
        -- N·∫øu kh√¥ng t√¨m th·∫•y character, coi nh∆∞ kh√¥ng th·ªÉ theo d√µi -> b·ªè ch·ªçn
        currentTarget = nil
	end

    highlightSelectedButton(currentTarget) -- Highlight n√∫t c·ªßa ng∆∞·ªùi ch∆°i m·ªõi (ho·∫∑c b·ªè highlight n·∫øu target b·ªã nil)
    if not currentTarget then
        print("Kh√¥ng th·ªÉ ƒë·∫∑t m·ª•c ti√™u, ƒë√£ b·ªè ch·ªçn.") -- Debug
    else
         print("ƒê√£ ƒë·∫∑t m·ª•c ti√™u th√†nh c√¥ng:", currentTarget.Name) -- Debug
    end
end

-- Function c·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i
local function updateList()
    print("ƒêang c·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi ch∆°i...") -- Debug
	-- X√≥a c√°c n√∫t c≈© v√† l√†m s·∫°ch table
    for _, btnInfo in pairs(buttons) do
        if btnInfo and btnInfo.button and btnInfo.button.Parent then btnInfo.button:Destroy() end
    end
	buttons = {} -- Reset table

	local yPos = listButtonYOffset -- B·∫Øt ƒë·∫ßu t·ª´ offset nh·ªè
	local canvasHeight = yPos -- Chi·ªÅu cao ban ƒë·∫ßu c·ªßa CanvasSize

	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= Player then -- B·ªè qua ng∆∞·ªùi ch∆°i c·ª•c b·ªô
			local btn = Instance.new("TextButton", playerList) -- Parent l√† playerList
			btn.Name = p.Name -- ƒê·∫∑t t√™n n√∫t ƒë·ªÉ d·ªÖ debug
			btn.Size = UDim2.new(1, -10, 0, 25) -- N√∫t nh·ªè h∆°n m·ªôt ch√∫t
			btn.Position = UDim2.new(0, 5, 0, yPos)
			btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
			btn.Text = p.Name
			btn.TextColor3 = Color3.new(1,1,1)
			btn.Font = Enum.Font.Gotham
			btn.TextSize = 13
			Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)

            -- Th√™m UIStroke ƒë·ªÉ l√†m vi·ªÅn khi ch·ªçn (m·∫∑c ƒë·ªãnh t·∫Øt)
            local stroke = Instance.new("UIStroke", btn)
            stroke.Color = Color3.fromRGB(255, 255, 0) -- M√†u v√†ng
            stroke.Thickness = 1.5 -- Vi·ªÅn d√†y h∆°n ch√∫t
            stroke.Enabled = false

			buttons[p] = {button = btn} -- L∆∞u n√∫t v√†o dictionary v·ªõi key l√† Player object

			btn.MouseButton1Click:Connect(function()
				setTarget(p)
			end)

			yPos += 25 + listButtonYOffset -- C·∫≠p nh·∫≠t v·ªã tr√≠ Y cho n√∫t ti·∫øp theo
            canvasHeight = yPos -- C·∫≠p nh·∫≠t chi·ªÅu cao c·∫ßn thi·∫øt cho canvas
		end
	end
	-- ƒê·∫∑t CanvasSize, √≠t nh·∫•t b·∫±ng k√≠ch th∆∞·ªõc c·ªßa ScrollingFrame ƒë·ªÉ thanh cu·ªôn ho·∫°t ƒë·ªông ƒë√∫ng
	playerList.CanvasSize = UDim2.new(0, 0, 0, math.max(canvasHeight, playerList.AbsoluteSize.Y))
    highlightSelectedButton(currentTarget) -- C·∫≠p nh·∫≠t highlight sau khi t·∫£i l·∫°i list
    print("C·∫≠p nh·∫≠t danh s√°ch ho√†n t·∫•t.") -- Debug
end

-- === X·ª≠ l√Ω s·ª± ki·ªán cho b·∫£n th√¢n ===

-- H√†m x·ª≠ l√Ω khi b·∫£n th√¢n ch·∫øt
local function handleSelfDied()
    print("Nh√¢n v·∫≠t c·ªßa b·∫°n ƒë√£ ch·∫øt!") -- Debug
    -- T·∫Øt c√°c ch·ª©c nƒÉng ƒëang ch·∫°y
    looking = false
    toggleButton.Text = "‚ùé T·∫Øt Nh√¨n"
    toggleButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)

    -- C√≥ th·ªÉ th√™m t·∫Øt c√°c ch·ª©c nƒÉng kh√°c n·∫øu c√≥ (v√≠ d·ª•: Follow)

    -- Ng·∫Øt k·∫øt n·ªëi Died c≈© (s·∫Ω k·∫øt n·ªëi l·∫°i khi nh√¢n v·∫≠t m·ªõi xu·∫•t hi·ªán)
    if selfHumanoidDiedConnection then
        selfHumanoidDiedConnection:Disconnect()
        selfHumanoidDiedConnection = nil
    end
end

-- H√†m c·∫≠p nh·∫≠t khi nh√¢n v·∫≠t c·ªßa b·∫£n th√¢n thay ƒë·ªïi (respawn)
local function onCharacterAdded(newCharacter)
    print("Nh√¢n v·∫≠t m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m.") -- Debug
    Character = newCharacter
    Humanoid = newCharacter:WaitForChild("Humanoid")
    HumanoidRootPart = newCharacter:WaitForChild("HumanoidRootPart")

    -- Ng·∫Øt k·∫øt n·ªëi Died c≈© n·∫øu c√≤n
	if selfHumanoidDiedConnection then
		selfHumanoidDiedConnection:Disconnect()
		selfHumanoidDiedConnection = nil
	end

    -- K·∫øt n·ªëi l·∫°i s·ª± ki·ªán Died cho humanoid m·ªõi
	if Humanoid then
	    selfHumanoidDiedConnection = Humanoid.Died:Connect(handleSelfDied)
        print("ƒê√£ k·∫øt n·ªëi Died cho nh√¢n v·∫≠t m·ªõi.") -- Debug
    else
        warn("Kh√¥ng t√¨m th·∫•y Humanoid cho nh√¢n v·∫≠t m·ªõi!")
    end
end

-- K·∫øt n·ªëi s·ª± ki·ªán CharacterAdded
Player.CharacterAdded:Connect(onCharacterAdded)

-- K·∫øt n·ªëi s·ª± ki·ªán Died cho nh√¢n v·∫≠t ban ƒë·∫ßu (n·∫øu ch∆∞a ch·∫øt)
if Humanoid then
    selfHumanoidDiedConnection = Humanoid.Died:Connect(handleSelfDied)
    print("ƒê√£ k·∫øt n·ªëi Died cho nh√¢n v·∫≠t ban ƒë·∫ßu.") -- Debug
end


-- === Logic n√∫t ===

-- Nearest Player Button Logic
nearestButton.MouseButton1Click:Connect(function()
    if not isSelfCharacterValid() then
        print("Nh√¢n v·∫≠t c·ªßa b·∫°n kh√¥ng h·ª£p l·ªá ƒë·ªÉ t√¨m ng∆∞·ªùi ch∆°i g·∫ßn nh·∫•t.") -- Debug
        return
    end

	local closestPlayer = nil
	local shortestDistance = math.huge
	local myRootPos = HumanoidRootPart.Position -- L·∫•y v·ªã tr√≠ t·ª´ bi·∫øn ƒë√£ c·∫≠p nh·∫≠t

	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= Player then -- B·ªè qua ch√≠nh m√¨nh
            local targetChar = p.Character
            if targetChar then
                local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    local distance = (targetRoot.Position - myRootPos).Magnitude
                    if distance < shortestDistance then
                        closestPlayer = p
                        shortestDistance = distance
                    end
                end
            end
		end
	end

	if closestPlayer then
        print("Ng∆∞·ªùi ch∆°i g·∫ßn nh·∫•t:", closestPlayer.Name) -- Debug
		setTarget(closestPlayer)
	else
        print("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i n√†o kh√°c g·∫ßn ƒë√≥.") -- Debug
    end
end)

-- Teleport Button Logic
teleportButton.MouseButton1Click:Connect(function()
	-- 1. Ki·ªÉm tra nh√¢n v·∫≠t b·∫£n th√¢n
    if not isSelfCharacterValid() then
        print("Kh√¥ng th·ªÉ d·ªãch chuy·ªÉn: Nh√¢n v·∫≠t c·ªßa b·∫°n kh√¥ng h·ª£p l·ªá.") -- Debug
        return
    end

    -- 2. Ki·ªÉm tra m·ª•c ti√™u ƒë√£ ch·ªçn
	if not currentTarget then
		print("Kh√¥ng th·ªÉ d·ªãch chuy·ªÉn: Ch∆∞a ch·ªçn m·ª•c ti√™u.") -- Debug
		return
	end

    -- 3. Ki·ªÉm tra nh√¢n v·∫≠t m·ª•c ti√™u
    if not isTargetCharacterValid(currentTarget) then
        print("Kh√¥ng th·ªÉ d·ªãch chuy·ªÉn: M·ª•c ti√™u kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ch·∫øt/r·ªùi ƒëi.") -- Debug
        -- T√πy ch·ªçn: C√≥ th·ªÉ t·ª± ƒë·ªông b·ªè ch·ªçn m·ª•c ti√™u ·ªü ƒë√¢y n·∫øu mu·ªën
        -- currentTarget = nil
        -- highlightSelectedButton(nil)
        -- if targetHumanoidConnection then targetHumanoidConnection:Disconnect(); targetHumanoidConnection = nil end
        return
    end

    -- L·∫•y c√°c b·ªô ph·∫≠n c·∫ßn thi·∫øt (ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra t·ªìn t·∫°i b·ªüi isTargetCharacterValid)
    local targetRoot = currentTarget.Character.HumanoidRootPart

    -- T√≠nh to√°n v·ªã tr√≠ ph√≠a sau m·ª•c ti√™u
    local targetLookVector = targetRoot.CFrame.LookVector -- H∆∞·ªõng nh√¨n c·ªßa m·ª•c ti√™u
    local distanceBehind = 1.5 -- Kho·∫£ng c√°ch sau l∆∞ng (M·∫∂C ƒê·ªäNH 1.5 block, c√≥ th·ªÉ ch·ªânh)
    local verticalOffset = 0.5 -- N√¢ng Y l√™n m·ªôt ch√∫t ƒë·ªÉ tr√°nh k·∫πt
    local teleportPosition = targetRoot.Position - (targetLookVector * distanceBehind) + Vector3.new(0, verticalOffset, 0)

    -- T·∫°o CFrame m·ªõi: v·ªã tr√≠ l√† ƒëi·ªÉm ƒë√£ t√≠nh, h∆∞·ªõng nh√¨n v·ªÅ m·ª•c ti√™u
    local newCFrame = CFrame.new(teleportPosition, targetRoot.Position)

    -- D·ªãch chuy·ªÉn nh√¢n v·∫≠t c·ªßa B·∫†N b·∫±ng SetPrimaryPartCFrame
    Character:SetPrimaryPartCFrame(newCFrame)
    print("ƒê√£ d·ªãch chuy·ªÉn ra sau l∆∞ng", currentTarget.Name) -- Debug

end)

-- Button Events
reloadButton.MouseButton1Click:Connect(updateList)

partButton.MouseButton1Click:Connect(function()
	partIndex = (partIndex % #bodyParts) + 1
	partButton.Text = "Nh√¨n: " .. bodyParts[partIndex]
end)

toggleButton.MouseButton1Click:Connect(function()
    -- Ch·ªâ b·∫≠t nh√¨n n·∫øu nh√¢n v·∫≠t b·∫£n th√¢n h·ª£p l·ªá
    if not looking and not isSelfCharacterValid() then
         print("Kh√¥ng th·ªÉ b·∫≠t nh√¨n: Nh√¢n v·∫≠t c·ªßa b·∫°n kh√¥ng h·ª£p l·ªá.")
         return
    end

	looking = not looking
	toggleButton.Text = looking and "‚úÖ B·∫≠t Nh√¨n" or "‚ùé T·∫Øt Nh√¨n"
	toggleButton.BackgroundColor3 = looking and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
    print("Tr·∫°ng th√°i nh√¨n ƒë√£ chuy·ªÉn th√†nh:", looking) -- Debug
end)

-- Minimize/Maximize
MinimizeButton.MouseButton1Click:Connect(function()
	Frame.Visible = false
	MinimizedIcon.Visible = true
end)
MinimizedIcon.MouseButton1Click:Connect(function()
	Frame.Visible = true
	MinimizedIcon.Visible = false
end)

-- Close
CloseButton.MouseButton1Click:Connect(function()
    print("ƒêang ƒë√≥ng GUI...") -- Debug
	-- Ng·∫Øt k·∫øt n·ªëi t·∫•t c·∫£ c√°c s·ª± ki·ªán v√† render step tr∆∞·ªõc khi h·ªßy
	if targetHumanoidConnection then
		targetHumanoidConnection:Disconnect()
        targetHumanoidConnection = nil
        print("ƒê√£ ng·∫Øt k·∫øt n·ªëi Died c·ªßa m·ª•c ti√™u khi ƒë√≥ng.") -- Debug
	end
	if selfHumanoidDiedConnection then
		selfHumanoidDiedConnection:Disconnect()
        selfHumanoidDiedConnection = nil
        print("ƒê√£ ng·∫Øt k·∫øt n·ªëi Died c·ªßa b·∫£n th√¢n khi ƒë√≥ng.") -- Debug
	end
    if lookAtRenderStepConnection then
        RunService:UnbindFromRenderStep("LookAtTarget")
        lookAtRenderStepConnection = nil
         print("ƒê√£ Unbind RenderStep LookAtTarget.") -- Debug
    end
	ScreenGui:Destroy() -- H·ªßy to√†n b·ªô GUI
    print("GUI ƒë√£ ƒë∆∞·ª£c h·ªßy.") -- Debug
end)

-- === Look logic (RenderStep) ===
local function lookAtTargetRenderStep()
    -- 1. Ki·ªÉm tra tr·∫°ng th√°i nh√¨n v√† m·ª•c ti√™u
    if not looking or not currentTarget then return end

    -- 2. Ki·ªÉm tra nh√¢n v·∫≠t b·∫£n th√¢n c√≤n h·ª£p l·ªá kh√¥ng
    if not isSelfCharacterValid() then
        -- N·∫øu nh√¢n v·∫≠t b·∫£n th√¢n kh√¥ng h·ª£p l·ªá, t·ª± ƒë·ªông t·∫Øt nh√¨n
        looking = false
        toggleButton.Text = "‚ùé T·∫Øt Nh√¨n"
        toggleButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
        print("T·ª± ƒë·ªông t·∫Øt nh√¨n do nh√¢n v·∫≠t b·∫£n th√¢n kh√¥ng h·ª£p l·ªá.") -- Debug
        return
    end

    -- 3. Ki·ªÉm tra m·ª•c ti√™u c√≤n h·ª£p l·ªá kh√¥ng
    if not isTargetCharacterValid(currentTarget) then
        -- N·∫øu m·ª•c ti√™u kh√¥ng h·ª£p l·ªá (ch·∫øt, r·ªùi game), t·ª± ƒë·ªông t·∫Øt nh√¨n v√† b·ªè ch·ªçn
        print("M·ª•c ti√™u kh√¥ng h·ª£p l·ªá trong RenderStep, ƒëang t·∫Øt nh√¨n v√† b·ªè ch·ªçn...") -- Debug
        handleTargetDied(currentTarget) -- G·ªçi h√†m x·ª≠ l√Ω ch·∫øt (s·∫Ω t·∫Øt nh√¨n, b·ªè ch·ªçn, ng·∫Øt k·∫øt n·ªëi)
        return
    end

    -- 4. Th·ª±c hi·ªán nh√¨n
    local targetChar = currentTarget.Character -- ƒê√£ ki·ªÉm tra t·ªìn t·∫°i b·ªüi isTargetCharacterValid
    local targetPart = targetChar:FindFirstChild(bodyParts[partIndex])

    if not targetPart then
        -- N·∫øu kh√¥ng t√¨m th·∫•y b·ªô ph·∫≠n c·ª• th·ªÉ, th·ª≠ nh√¨n v√†o HumanoidRootPart
        targetPart = targetChar:FindFirstChild("HumanoidRootPart")
    end

    if targetPart then
        local lookFrom = Camera.CFrame.Position
        local lookAt = targetPart.Position
        -- Ki·ªÉm tra kho·∫£ng c√°ch tr√°nh l·ªói CFrame khi v·ªã tr√≠ camera tr√πng v·ªõi m·ª•c ti√™u
        if (lookFrom - lookAt).Magnitude > 0.1 then
            Camera.CFrame = CFrame.new(lookFrom, lookAt)
        end
    else
         -- N·∫øu kh√¥ng t√¨m th·∫•y c·∫£ b·ªô ph·∫≠n mong mu·ªën v√† HRP (r·∫•t hi·∫øm), th√¨ kh√¥ng l√†m g√¨ c·∫£ trong frame n√†y
         -- Logic isTargetCharacterValid ·ªü tr√™n ƒë√£ ƒë·∫£m b·∫£o HRP t·ªìn t·∫°i, n√™n tr∆∞·ªùng h·ª£p n√†y kh√≥ x·∫£y ra
         warn("Kh√¥ng t√¨m th·∫•y b·ªô ph·∫≠n h·ª£p l·ªá ƒë·ªÉ nh√¨n v√†o cho m·ª•c ti√™u:", currentTarget.Name)
    end
end

-- Bind look logic to RenderStep
-- Ch·ªâ bind n·∫øu ch∆∞a c√≥ connection n√†o
if not lookAtRenderStepConnection then
    lookAtRenderStepConnection = RunService:BindToRenderStep("LookAtTarget", Enum.RenderPriority.Camera.Value + 1, lookAtTargetRenderStep)
    print("ƒê√£ Bind RenderStep LookAtTarget.") -- Debug
end

-- B·ªè bind khi GUI b·ªã h·ªßy ƒë·ªÉ tr√°nh l·ªói (ƒë√£ x·ª≠ l√Ω trong s·ª± ki·ªán CloseButton)
ScreenGui.Destroying:Connect(function()
    print("S·ª± ki·ªán ScreenGui.Destroying ƒë∆∞·ª£c k√≠ch ho·∫°t.") -- Debug
	if targetHumanoidConnection then
		targetHumanoidConnection:Disconnect()
        targetHumanoidConnection = nil
        print("ƒê√£ ng·∫Øt k·∫øt n·ªëi Died c·ªßa m·ª•c ti√™u trong Destroying.") -- Debug
	end
    if selfHumanoidDiedConnection then
		selfHumanoidDiedConnection:Disconnect()
        selfHumanoidDiedConnection = nil
        print("ƒê√£ ng·∫Øt k·∫øt n·ªëi Died c·ªßa b·∫£n th√¢n trong Destroying.") -- Debug
	end
    -- ƒê·∫£m b·∫£o unbind ngay c·∫£ khi kh√¥ng b·∫•m n√∫t Close
    if lookAtRenderStepConnection then
        pcall(function() RunService:UnbindFromRenderStep("LookAtTarget") end)
        lookAtRenderStepConnection = nil
        print("ƒê√£ Unbind RenderStep LookAtTarget trong Destroying.") -- Debug
    end
    print("LookAt GUI Destroyed and Connections Cleaned.") -- Debug
end)


-- === Init ===
updateList() -- T·∫£i danh s√°ch ng∆∞·ªùi ch∆°i l·∫ßn ƒë·∫ßu
print("LookAt GUI Loaded and Initialized.") -- Debug

-- T·ª± ƒë·ªông b·∫≠t nh√¨n l√∫c ƒë·∫ßu (n·∫øu mu·ªën)
-- looking = true
-- toggleButton.Text = "‚úÖ B·∫≠t Nh√¨n"
-- toggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)

-- T·ª± ƒë·ªông t·∫Øt nh√¨n l√∫c ƒë·∫ßu (an to√†n h∆°n)
looking = false
toggleButton.Text = "‚ùé T·∫Øt Nh√¨n"
toggleButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)

