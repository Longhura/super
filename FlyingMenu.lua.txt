-- Script Bay Đơn Giản Cho Mobile
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- Biến điều khiển
local flying = false
local speed = 40
local touchControls = {up = false, down = false}
local moveVector = Vector3.new(0, 0, 0)
local camera = workspace.CurrentCamera

-- Tạo GUI đơn giản
local gui = Instance.new("ScreenGui")
gui.Name = "FlyGui"
gui.ResetOnSpawn = false
gui.Parent = player.PlayerGui

-- Nút bay
local flyButton = Instance.new("TextButton")
flyButton.Name = "FlyButton"
flyButton.Size = UDim2.new(0, 70, 0, 70)
flyButton.Position = UDim2.new(0.5, -35, 0.1, 0)
flyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
flyButton.Text = "✈️"
flyButton.TextSize = 30
flyButton.Font = Enum.Font.SourceSansBold
flyButton.Parent = gui

-- Làm tròn nút
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(1, 0)
corner.Parent = flyButton

-- Nút lên
local upButton = Instance.new("TextButton")
upButton.Name = "UpButton"
upButton.Size = UDim2.new(0, 60, 0, 60)
upButton.Position = UDim2.new(0.9, -30, 0.7, -30)
upButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
upButton.Text = "▲"
upButton.TextSize = 30
upButton.Font = Enum.Font.SourceSansBold
upButton.Visible = false
upButton.Parent = gui

-- Làm tròn nút lên
local upCorner = Instance.new("UICorner")
upCorner.CornerRadius = UDim.new(1, 0)
upCorner.Parent = upButton

-- Nút xuống
local downButton = Instance.new("TextButton")
downButton.Name = "DownButton"
downButton.Size = UDim2.new(0, 60, 0, 60)
downButton.Position = UDim2.new(0.9, -30, 0.85, -30)
downButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
downButton.Text = "▼"
downButton.TextSize = 30
downButton.Font = Enum.Font.SourceSansBold
downButton.Visible = false
downButton.Parent = gui

-- Làm tròn nút xuống
local downCorner = Instance.new("UICorner")
downCorner.CornerRadius = UDim.new(1, 0)
downCorner.Parent = downButton

-- Joystick
local joystick = Instance.new("Frame")
joystick.Name = "Joystick"
joystick.Size = UDim2.new(0, 120, 0, 120)
joystick.Position = UDim2.new(0.1, 0, 0.7, 0)
joystick.BackgroundTransparency = 0.5
joystick.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
joystick.Visible = false
joystick.Parent = gui

-- Làm tròn joystick
local joystickCorner = Instance.new("UICorner")
joystickCorner.CornerRadius = UDim.new(1, 0)
joystickCorner.Parent = joystick

-- Nút joystick
local joystickKnob = Instance.new("Frame")
joystickKnob.Name = "Knob"
joystickKnob.Size = UDim2.new(0, 40, 0, 40)
joystickKnob.Position = UDim2.new(0.5, -20, 0.5, -20)
joystickKnob.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
joystickKnob.Parent = joystick

-- Làm tròn nút joystick
local knobCorner = Instance.new("UICorner")
knobCorner.CornerRadius = UDim.new(1, 0)
knobCorner.Parent = joystickKnob

-- Biến joystick
local joystickInUse = false
local joystickTouchId = nil
local joystickCenter = Vector2.new()
local joystickPosition = Vector2.new()
local joystickRadius = 60
local joystickMax = 40

-- Xử lý nút bay
flyButton.TouchTap:Connect(function()
    flying = not flying
    
    if flying then
        -- Bật bay
        flyButton.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        upButton.Visible = true
        downButton.Visible = true
        joystick.Visible = true
        
        -- Tạo BodyGyro và BodyVelocity
        local gyro = Instance.new("BodyGyro")
        gyro.Name = "FlyGyro"
        gyro.P = 9000
        gyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
        gyro.CFrame = rootPart.CFrame
        gyro.Parent = rootPart
        
        local velocity = Instance.new("BodyVelocity")
        velocity.Name = "FlyVelocity"
        velocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
        velocity.Velocity = Vector3.new(0, 0.1, 0)
        velocity.Parent = rootPart
        
        -- Cập nhật bay
        RunService:BindToRenderStep("Flying", Enum.RenderPriority.Character.Value, function()
            if not flying then return end
            
            local lookVector = camera.CFrame.LookVector
            local rightVector = camera.CFrame.RightVector
            
            -- Tính toán hướng bay từ joystick
            local moveDirection = Vector3.new(0, 0, 0)
            
            if joystickInUse then
                local joystickDelta = joystickPosition - joystickCenter
                local joystickMagnitude = joystickDelta.Magnitude / joystickMax
                joystickMagnitude = math.min(joystickMagnitude, 1)
                
                if joystickDelta.Magnitude > 0 then
                    local normalizedDelta = joystickDelta.Unit
                    
                    local forwardAmount = -normalizedDelta.Y * joystickMagnitude
                    local rightAmount = normalizedDelta.X * joystickMagnitude
                    
                    moveDirection = lookVector * forwardAmount + rightVector * rightAmount
                end
            end
            
            -- Thêm chuyển động lên/xuống
            if touchControls.up then
                moveDirection = moveDirection + Vector3.new(0, 1, 0)
            end
            if touchControls.down then
                moveDirection = moveDirection - Vector3.new(0, 1, 0)
            end
            
            if moveDirection.Magnitude > 0 then
                moveDirection = moveDirection.Unit
            end
            
            -- Cập nhật vận tốc
            velocity.Velocity = moveDirection * speed
            
            -- Cập nhật hướng nhìn
            if moveDirection.Magnitude > 0 then
                gyro.CFrame = CFrame.lookAt(rootPart.Position, rootPart.Position + moveDirection)
            else
                gyro.CFrame = CFrame.lookAt(rootPart.Position, rootPart.Position + camera.CFrame.LookVector)
            end
        end)
    else
        -- Tắt bay
        flyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        upButton.Visible = false
        downButton.Visible = false
        joystick.Visible = false
        
        -- Xóa BodyGyro và BodyVelocity
        RunService:UnbindFromRenderStep("Flying")
        
        if rootPart:FindFirstChild("FlyGyro") then
            rootPart.FlyGyro:Destroy()
        end
        
        if rootPart:FindFirstChild("FlyVelocity") then
            rootPart.FlyVelocity:Destroy()
        end
        
        -- Đặt lại trạng thái nhân vật
        humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
    end
end)

-- Xử lý nút lên/xuống
upButton.TouchTap:Connect(function() touchControls.up = not touchControls.up end)
upButton.TouchStarted:Connect(function() touchControls.up = true end)
upButton.TouchEnded:Connect(function() touchControls.up = false end)

downButton.TouchTap:Connect(function() touchControls.down = not touchControls.down end)
downButton.TouchStarted:Connect(function() touchControls.down = true end)
downButton.TouchEnded:Connect(function() touchControls.down = false end)

-- Xử lý joystick
joystick.TouchStarted:Connect(function(touch)
    joystickInUse = true
    joystickTouchId = touch.Touch.TouchId
    joystickCenter = Vector2.new(joystick.AbsolutePosition.X + joystick.AbsoluteSize.X/2, 
                                joystick.AbsolutePosition.Y + joystick.AbsoluteSize.Y/2)
    joystickPosition = Vector2.new(touch.Position.X, touch.Position.Y)
    
    -- Cập nhật vị trí knob
    local knobX = (joystickPosition.X - joystick.AbsolutePosition.X) - joystickKnob.AbsoluteSize.X/2
    local knobY = (joystickPosition.Y - joystick.AbsolutePosition.Y) - joystickKnob.AbsoluteSize.Y/2
    joystickKnob.Position = UDim2.new(0, knobX, 0, knobY)
end)

joystick.TouchMoved:Connect(function(touch)
    if joystickInUse and touch.Touch.TouchId == joystickTouchId then
        joystickPosition = Vector2.new(touch.Position.X, touch.Position.Y)
        
        -- Giới hạn vị trí joystick
        local delta = joystickPosition - joystickCenter
        local magnitude = delta.Magnitude
        
        if magnitude > joystickMax then
            joystickPosition = joystickCenter + delta.Unit * joystickMax
        end
        
        -- Cập nhật vị trí knob
        local knobX = (joystickPosition.X - joystick.AbsolutePosition.X) - joystickKnob.AbsoluteSize.X/2
        local knobY = (joystickPosition.Y - joystick.AbsolutePosition.Y) - joystickKnob.AbsoluteSize.Y/2
        joystickKnob.Position = UDim2.new(0, knobX, 0, knobY)
    end
end)

joystick.TouchEnded:Connect(function(touch)
    if joystickInUse and touch.Touch.TouchId == joystickTouchId then
        joystickInUse = false
        joystickTouchId = nil
        joystickKnob.Position = UDim2.new(0.5, -20, 0.5, -20)
    end
end)

-- Xử lý khi nhân vật chết
humanoid.Died:Connect(function()
    flying = false
    
    upButton.Visible = false
    downButton.Visible = false
    joystick.Visible = false
    flyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    
    RunService:UnbindFromRenderStep("Flying")
    
    if rootPart:FindFirstChild("FlyGyro") then
        rootPart.FlyGyro:Destroy()
    end
    
    if rootPart:FindFirstChild("FlyVelocity") then
        rootPart.FlyVelocity:Destroy()
    end
end)

-- Xử lý khi nhân vật được tạo lại
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
    
    flying = false
    upButton.Visible = false
    downButton.Visible = false
    joystick.Visible = false
    flyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
end)

print("Script bay đơn giản cho mobile đã được khởi tạo!")
